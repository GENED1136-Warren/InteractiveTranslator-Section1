<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>China: Power and Civilization - Interactive Translation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --jade-green: #00A86B;
            --ink-black: #2B2B2B;
            --paper-beige: #F5F5DC;
        }

        body {
            background: linear-gradient(135deg, #F5F5DC 0%, #FAFAF0 100%);
            font-family: 'Inter', sans-serif;
        }

        .chinese-title {
            font-family: 'Noto Serif SC', serif;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .sentence {
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline;
            padding: 2px 4px;
            border-radius: 3px;
            position: relative;
        }
        
        .sentence:hover {
            background-color: rgba(255, 215, 0, 0.1);
            box-shadow: 0 2px 4px rgba(139, 0, 0, 0.1);
        }
        
        .sentence.highlighted {
            background: linear-gradient(90deg, 
                rgba(255, 215, 0, 0.3), 
                rgba(255, 215, 0, 0.15));
            border-left: 3px solid var(--chinese-red);
            font-weight: 500;
            padding-left: 6px;
        }

        .multi-select-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--chinese-red);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .multi-select-indicator.active {
            display: block;
        }
        
        .text-panel {
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            min-height: 400px;
            overflow-y: auto;
            max-height: 600px;
            border-top: 4px solid;
            position: relative;
            background-image: 
                linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.95)),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.03"><text x="50" y="50" font-size="40" text-anchor="middle" fill="%23000">文</text></svg>');
            background-size: cover, 150px;
            background-position: center;
        }
        
        .panel-ancient { 
            border-top-color: var(--chinese-red);
            font-family: 'Noto Serif SC', serif;
        }
        .panel-modern { 
            border-top-color: var(--jade-green);
        }
        .panel-english { 
            border-top-color: #4A90E2;
        }
        
        .chinese-button {
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }

        .chinese-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 0, 0, 0.3);
            border-color: var(--chinese-gold);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(139, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--chinese-red);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid;
            font-family: 'Noto Serif SC', serif;
        }

        .panel-ancient .panel-title { border-bottom-color: var(--chinese-red); }
        .panel-modern .panel-title { border-bottom-color: var(--jade-green); }
        .panel-english .panel-title { border-bottom-color: #4A90E2; }
        
        .language-option {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .language-option:hover {
            background-color: rgba(255, 215, 0, 0.05);
            border-color: var(--chinese-gold);
        }
        
        .language-option input:checked + span {
            color: var(--chinese-red);
            font-weight: 500;
        }
        
        .language-section {
            background: linear-gradient(135deg, rgba(245, 245, 220, 0.3), rgba(255, 255, 255, 0.5));
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(139, 0, 0, 0.1);
        }

        .model-selector {
            background: white;
            border: 2px solid rgba(139, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 14px;
            transition: all 0.2s;
        }

        .model-selector:focus {
            outline: none;
            border-color: var(--chinese-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .chinese-header {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.05));
            border-bottom: 2px solid rgba(139, 0, 0, 0.1);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .tip-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 255, 255, 0.5));
            border-left: 4px solid var(--chinese-gold);
            padding: 0.75rem 1rem;
            margin: 1rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 14px;
            color: var(--ink-black);
        }

        .selected-count {
            background: var(--chinese-red);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* Enhanced Query Interface Styles */
        .conversation-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(245, 245, 220, 0.1));
        }

        .message-user {
            background: rgba(139, 0, 0, 0.05);
            border-left: 3px solid var(--chinese-red);
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0 4px 4px 0;
        }

        .message-assistant {
            background: rgba(0, 168, 107, 0.05);
            border-left: 3px solid var(--jade-green);
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0 4px 4px 0;
        }

        .markdown-body {
            padding: 1rem;
            font-family: 'Inter', 'Noto Serif SC', sans-serif;
            line-height: 1.6;
        }

        .response-container {
            position: relative;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(139, 0, 0, 0.1);
            overflow: hidden;
        }

        .response-controls {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(245, 245, 220, 0.2);
            border-bottom: 1px solid rgba(139, 0, 0, 0.1);
        }

        .control-button {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid;
        }

        .copy-button {
            background: var(--chinese-gold);
            color: var(--ink-black);
            border-color: var(--chinese-gold);
        }

        .copy-button:hover {
            background: var(--chinese-red);
            color: white;
            border-color: var(--chinese-red);
        }

        .copy-success {
            animation: fadeInOut 2s;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .markdown-toggle {
            background: transparent;
            border-color: var(--chinese-red);
            color: var(--chinese-red);
        }

        .markdown-toggle:hover {
            background: var(--chinese-red);
            color: white;
        }

        .clear-button {
            background: transparent;
            border-color: #dc2626;
            color: #dc2626;
        }

        .clear-button:hover {
            background: #dc2626;
            color: white;
        }

        .continue-button {
            background: var(--jade-green);
            color: white;
            border-color: var(--jade-green);
        }

        .continue-button:hover {
            background: #00916a;
            border-color: #00916a;
        }

        .query-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .conversation-empty {
            text-align: center;
            color: #999;
            padding: 2rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="chinese-header">
        <div class="container mx-auto px-6">
            <h1 class="chinese-title text-4xl font-bold text-center">
                中華文明 · China: Power and Civilization
            </h1>
            <p class="text-center mt-2 text-gray-600">Interactive Translation System · 互動翻譯系統</p>
        </div>
    </div>

    <div class="container mx-auto p-6">
        <!-- Input Section -->
        <div class="mb-6 bg-white p-6 rounded-lg shadow-lg border border-gray-200">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">
                <span style="color: var(--chinese-red);">◈</span> Input Text
            </h2>
            <textarea 
                id="input-text" 
                class="w-full p-3 border-2 border-gray-300 rounded-md focus:ring-2 focus:ring-red-800 focus:border-red-800"
                rows="4"
                placeholder="Enter text to translate... 輸入要翻譯的文本..."
                style="background: rgba(245, 245, 220, 0.05);"></textarea>
            
            <!-- Language and Model Selection -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Input Language Selection -->
                <div class="language-section">
                    <h3 class="font-semibold mb-3 text-gray-700">
                        <span style="color: var(--chinese-red);">◆</span> Input Language
                    </h3>
                    <div class="space-y-2">
                        <label class="language-option flex items-center">
                            <input type="radio" name="input-lang" value="ancient" checked>
                            <span class="ml-2">Ancient Chinese · 古文</span>
                        </label>
                        <label class="language-option flex items-center">
                            <input type="radio" name="input-lang" value="modern">
                            <span class="ml-2">Modern Chinese · 现代中文</span>
                        </label>
                        <label class="language-option flex items-center">
                            <input type="radio" name="input-lang" value="english">
                            <span class="ml-2">English</span>
                        </label>
                    </div>
                </div>
                
                <!-- Output Language Selection -->
                <div class="language-section">
                    <h3 class="font-semibold mb-3 text-gray-700">
                        <span style="color: var(--chinese-red);">◆</span> Output Languages
                    </h3>
                    <div class="space-y-2" id="output-languages">
                        <label class="language-option flex items-center" data-lang="ancient" style="display: none;">
                            <input type="checkbox" name="output-lang" value="ancient">
                            <span class="ml-2">Ancient Chinese · 古文</span>
                        </label>
                        <label class="language-option flex items-center" data-lang="modern">
                            <input type="checkbox" name="output-lang" value="modern" checked>
                            <span class="ml-2">Modern Chinese · 现代中文</span>
                        </label>
                        <label class="language-option flex items-center" data-lang="english">
                            <input type="checkbox" name="output-lang" value="english" checked>
                            <span class="ml-2">English</span>
                        </label>
                    </div>
                </div>

                <!-- Model Selection -->
                <div class="language-section">
                    <h3 class="font-semibold mb-3 text-gray-700">
                        <span style="color: var(--chinese-red);">◆</span> AI Model
                    </h3>
                    <select id="model-selector" class="model-selector w-full">
                        <option value="opus">Claude Opus (Latest) - Higher Quality</option>
                        <option value="sonnet">Claude Sonnet (Latest) - Faster</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">Choose based on speed vs quality preference</p>
                </div>
            </div>

            <div class="tip-box">
                💡 <strong>Tip:</strong> Hold <kbd>Cmd</kbd> (Mac) or <kbd>Ctrl</kbd> (PC) while clicking sentences to select multiple sentences for analysis
            </div>
            
            <div class="mt-4 flex gap-3">
                <button 
                    id="translate-btn"
                    class="px-6 py-2 chinese-button rounded-md transition">
                    翻譯 · Translate
                </button>
                <button 
                    id="load-sample-btn"
                    class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">
                    示例 · Load Sample
                </button>
                <button 
                    id="clear-btn"
                    class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                    清除 · Clear
                </button>
            </div>
            <div id="translation-status" class="mt-3 text-sm text-gray-600"></div>
        </div>

        <!-- Translation Panels (Dynamically shown) -->
        <div id="translation-panels" class="mb-6" style="display: none;">
            <div id="panels-container" class="grid gap-4">
                <!-- Panels will be dynamically inserted here -->
            </div>
        </div>

        <!-- Enhanced Query Interface -->
        <div id="query-section" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200" style="display: none;">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">
                <span style="color: var(--chinese-red);">❓</span> 詢問選定文本 · Ask About Selected Text
                <span id="selected-count" class="selected-count" style="display: none;">0 sentences</span>
            </h2>
            
            <!-- Selected Text Display -->
            <div class="mb-3">
                <div class="text-sm text-gray-600 mb-1">選定文本 · Selected text:</div>
                <div id="selected-text" class="p-3 bg-yellow-50 rounded-md text-gray-800 italic border-l-4 border-yellow-400"></div>
            </div>
            
            <!-- Conversation History -->
            <div id="conversation-history-container" style="display: none;">
                <div class="text-sm text-gray-600 mb-2">對話歷史 · Conversation History:</div>
                <div id="conversation-history" class="conversation-history">
                    <div class="conversation-empty">No conversation history yet</div>
                </div>
            </div>
            
            <!-- Query Input -->
            <div class="query-input-group">
                <input 
                    id="query-input" 
                    type="text" 
                    class="flex-1 p-3 border-2 border-gray-300 rounded-md focus:ring-2 focus:ring-red-800"
                    placeholder="Ask a question... 提出問題..."
                    disabled>
                <button 
                    id="continue-btn"
                    class="px-4 py-2 control-button continue-button"
                    style="display: none;">
                    繼續 · Continue
                </button>
                <button 
                    id="clear-conversation-btn"
                    class="px-4 py-2 control-button clear-button"
                    style="display: none;">
                    清除對話 · Clear
                </button>
                <button 
                    id="query-btn"
                    class="px-6 py-2 chinese-button rounded-md disabled:bg-gray-400"
                    disabled>
                    問 AI · Ask AI
                </button>
            </div>
            
            <!-- AI Response -->
            <div class="text-sm text-gray-600 mb-2">AI 回應 · AI Response:</div>
            <div class="response-container">
                <div class="response-controls">
                    <button id="copy-btn" class="control-button copy-button" style="display: none;">
                        複製 · Copy
                    </button>
                    <button id="markdown-toggle" class="control-button markdown-toggle" style="display: none;">
                        原始 · Raw
                    </button>
                </div>
                <div id="query-response" class="p-4 markdown-body"></div>
            </div>
        </div>

        <!-- Multi-select indicator -->
        <div id="multi-select-indicator" class="multi-select-indicator">
            <span id="multi-select-count">0</span> sentences selected
        </div>
    </div>

    <script>
        let translationData = {
            originalText: '',
            inputLanguage: 'ancient',
            outputLanguages: ['modern', 'english'],
            sentences: new Map(),
            selectedSentences: new Set(),
            model: 'opus'
        };

        let conversationHistory = {
            messages: [],
            selectedContext: null,
            currentResponse: '',
            showRawMarkdown: false
        };

        const languageNames = {
            ancient: 'Ancient Chinese · 古文',
            modern: 'Modern Chinese · 现代中文',
            english: 'English'
        };

        // Initialize marked options
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });

        // Model selection handler
        document.getElementById('model-selector').addEventListener('change', (e) => {
            translationData.model = e.target.value;
        });

        // Handle input language change
        document.querySelectorAll('input[name="input-lang"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                translationData.inputLanguage = e.target.value;
                updateOutputLanguageOptions();
            });
        });

        // Update output language options based on input selection
        function updateOutputLanguageOptions() {
            const inputLang = translationData.inputLanguage;
            const outputContainer = document.getElementById('output-languages');
            
            // Show/hide options based on input language
            outputContainer.querySelectorAll('.language-option').forEach(label => {
                const langValue = label.dataset.lang;
                if (langValue === inputLang) {
                    label.style.display = 'none';
                    label.querySelector('input').checked = false;
                } else {
                    label.style.display = 'flex';
                }
            });
            
            // Ensure at least one output is selected
            const checkedOutputs = outputContainer.querySelectorAll('input:checked');
            if (checkedOutputs.length === 0) {
                const firstVisible = outputContainer.querySelector('.language-option:not([style*="none"]) input');
                if (firstVisible) firstVisible.checked = true;
            }
            
            updateSelectedOutputLanguages();
        }

        // Update selected output languages
        function updateSelectedOutputLanguages() {
            translationData.outputLanguages = Array.from(
                document.querySelectorAll('input[name="output-lang"]:checked')
            ).map(cb => cb.value);
        }

        // Handle output language changes
        document.querySelectorAll('input[name="output-lang"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateSelectedOutputLanguages();
                
                // Ensure at least one is selected
                if (translationData.outputLanguages.length === 0) {
                    checkbox.checked = true;
                    updateSelectedOutputLanguages();
                    alert('At least one output language must be selected');
                }
            });
        });

        // Clear button
        document.getElementById('clear-btn').addEventListener('click', () => {
            document.getElementById('input-text').value = '';
            document.getElementById('translation-panels').style.display = 'none';
            document.getElementById('query-section').style.display = 'none';
            document.getElementById('translation-status').textContent = '';
            translationData.sentences.clear();
            translationData.selectedSentences.clear();
            conversationHistory.messages = [];
            updateMultiSelectIndicator();
            clearConversation();
        });

        // Sample text loader
        document.getElementById('load-sample-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/translate_this_text.txt');
                const text = await response.text();
                document.getElementById('input-text').value = text.trim();
                // Set input language to Ancient Chinese for sample
                document.querySelector('input[name="input-lang"][value="ancient"]').checked = true;
                translationData.inputLanguage = 'ancient';
                updateOutputLanguageOptions();
            } catch (error) {
                console.error('Error loading sample text:', error);
                document.getElementById('translation-status').textContent = 'Error loading sample text';
            }
        });

        // Translation handler
        document.getElementById('translate-btn').addEventListener('click', async () => {
            const text = document.getElementById('input-text').value.trim();
            if (!text) {
                alert('Please enter text to translate');
                return;
            }

            if (translationData.outputLanguages.length === 0) {
                alert('Please select at least one output language');
                return;
            }

            const statusEl = document.getElementById('translation-status');
            const translateBtn = document.getElementById('translate-btn');
            const modelName = translationData.model === 'opus' ? 'Claude Opus' : 'Claude Sonnet';
            
            statusEl.innerHTML = `<span class="loading"></span> Translating with ${modelName}...`;
            translateBtn.disabled = true;
            translationData.originalText = text;

            try {
                const response = await fetch('/api/segment-and-translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        inputLanguage: translationData.inputLanguage,
                        outputLanguages: translationData.outputLanguages,
                        model: translationData.model
                    })
                });

                if (!response.ok) {
                    throw new Error(`Translation failed: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Parse and display translations
                displayTranslations(result);
                
                statusEl.textContent = `Translation complete! (${modelName})`;
                document.getElementById('translation-panels').style.display = 'block';
                document.getElementById('query-section').style.display = 'block';
                
                // Clear conversation when new translation is done
                clearConversation();
                
            } catch (error) {
                console.error('Translation error:', error);
                statusEl.textContent = `Error: ${error.message}`;
            } finally {
                translateBtn.disabled = false;
            }
        });

        // Display translations with dynamic panels
        function displayTranslations(result) {
            const panelsContainer = document.getElementById('panels-container');
            panelsContainer.innerHTML = '';
            
            // Clear existing data
            translationData.sentences.clear();
            translationData.selectedSentences.clear();
            updateMultiSelectIndicator();
            
            // Determine which panels to show
            const panelsToShow = [];
            
            // Add input language panel
            panelsToShow.push({
                language: translationData.inputLanguage,
                content: result.original.text,
                isInput: true
            });
            
            // Add output language panels in order
            if (result.translations) {
                for (const lang of ['ancient', 'modern', 'english']) {
                    if (result.translations[lang]) {
                        panelsToShow.push({
                            language: lang,
                            content: result.translations[lang],
                            isInput: false
                        });
                    }
                }
            }
            
            // Set grid columns based on panel count
            panelsContainer.className = `grid gap-4 ${
                panelsToShow.length === 1 ? 'grid-cols-1' :
                panelsToShow.length === 2 ? 'grid-cols-1 md:grid-cols-2' :
                'grid-cols-1 md:grid-cols-3'
            }`;
            
            // Create panels
            panelsToShow.forEach(panel => {
                const panelDiv = document.createElement('div');
                panelDiv.className = `text-panel panel-${panel.language}`;
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'panel-title text-gray-700';
                titleDiv.textContent = languageNames[panel.language];
                if (panel.isInput) {
                    titleDiv.textContent += ' (Input)';
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.id = `panel-${panel.language}`;
                contentDiv.className = 'text-lg leading-relaxed';
                
                panelDiv.appendChild(titleDiv);
                panelDiv.appendChild(contentDiv);
                panelsContainer.appendChild(panelDiv);
                
                // Parse and display sentences
                const sentences = parseSentences(panel.content);
                sentences.forEach(({ id, text }) => {
                    if (!translationData.sentences.has(id)) {
                        translationData.sentences.set(id, {});
                    }
                    translationData.sentences.get(id)[panel.language] = text;
                });
                displaySentences(`panel-${panel.language}`, sentences);
            });
        }

        // Parse sentences with XML markers
        function parseSentences(text) {
            const sentences = [];
            const regex = /<s(\d+)>(.*?)<\/s\d+>/g;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                sentences.push({
                    id: `s${match[1]}`,
                    text: match[2]
                });
            }
            
            return sentences;
        }

        // Display sentences with click handlers
        function displaySentences(panelId, sentences) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            
            panel.innerHTML = '';
            
            sentences.forEach(({ id, text }) => {
                const span = document.createElement('span');
                span.className = 'sentence';
                span.dataset.sentenceId = id;
                span.textContent = text;
                span.addEventListener('click', (e) => handleSentenceClick(id, e));
                panel.appendChild(span);
                
                // Add space between sentences
                panel.appendChild(document.createTextNode(' '));
            });
        }

        // Handle sentence selection with multi-select support
        function handleSentenceClick(sentenceId, event) {
            if (event.metaKey || event.ctrlKey) {
                // Multi-select mode
                if (translationData.selectedSentences.has(sentenceId)) {
                    translationData.selectedSentences.delete(sentenceId);
                    removeSentenceHighlight(sentenceId);
                } else {
                    translationData.selectedSentences.add(sentenceId);
                    addSentenceHighlight(sentenceId);
                }
            } else {
                // Single select - clear others
                clearAllHighlights();
                translationData.selectedSentences.clear();
                translationData.selectedSentences.add(sentenceId);
                addSentenceHighlight(sentenceId);
            }
            
            updateSelectedDisplay();
            updateMultiSelectIndicator();
            
            // Store selected context for conversation
            conversationHistory.selectedContext = Array.from(translationData.selectedSentences).map(id => {
                const sentenceData = translationData.sentences.get(id);
                return sentenceData[translationData.inputLanguage] || Object.values(sentenceData)[0];
            }).join(' ');
        }

        function addSentenceHighlight(sentenceId) {
            document.querySelectorAll(`[data-sentence-id="${sentenceId}"]`).forEach(el => {
                el.classList.add('highlighted');
            });
        }

        function removeSentenceHighlight(sentenceId) {
            document.querySelectorAll(`[data-sentence-id="${sentenceId}"]`).forEach(el => {
                el.classList.remove('highlighted');
            });
        }

        function clearAllHighlights() {
            document.querySelectorAll('.sentence').forEach(el => {
                el.classList.remove('highlighted');
            });
        }

        function updateSelectedDisplay() {
            const selectedCount = translationData.selectedSentences.size;
            
            if (selectedCount > 0) {
                // Get all selected sentences text
                const selectedTexts = Array.from(translationData.selectedSentences).map(id => {
                    const sentenceData = translationData.sentences.get(id);
                    return sentenceData[translationData.inputLanguage] || Object.values(sentenceData)[0];
                });
                
                document.getElementById('selected-text').textContent = selectedTexts.join(' ');
                document.getElementById('query-input').disabled = false;
                document.getElementById('query-btn').disabled = false;
                
                // Update selected count badge
                const countBadge = document.getElementById('selected-count');
                if (selectedCount > 1) {
                    countBadge.textContent = `${selectedCount} sentences`;
                    countBadge.style.display = 'inline-block';
                } else {
                    countBadge.style.display = 'none';
                }
            } else {
                document.getElementById('selected-text').textContent = 'Click on a sentence to select it';
                document.getElementById('query-input').disabled = true;
                document.getElementById('query-btn').disabled = true;
                document.getElementById('selected-count').style.display = 'none';
            }
        }

        function updateMultiSelectIndicator() {
            const indicator = document.getElementById('multi-select-indicator');
            const count = translationData.selectedSentences.size;
            
            if (count > 1) {
                document.getElementById('multi-select-count').textContent = count;
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        // Enhanced Query Functions
        async function sendQuery(isContination = false) {
            const question = document.getElementById('query-input').value.trim();
            if (!question) {
                alert('Please enter a question');
                return;
            }

            if (translationData.selectedSentences.size === 0 && !isContination) {
                alert('Please select at least one sentence first');
                return;
            }

            const responseEl = document.getElementById('query-response');
            const queryBtn = document.getElementById('query-btn');
            const continueBtn = document.getElementById('continue-btn');
            const modelName = translationData.model === 'opus' ? 'Claude Opus' : 'Claude Sonnet';
            
            responseEl.innerHTML = `<span class="loading"></span> ${modelName} is thinking...`;
            queryBtn.disabled = true;
            if (continueBtn) continueBtn.disabled = true;

            // Add user message to history
            conversationHistory.messages.push({
                role: 'user',
                content: question,
                timestamp: new Date()
            });

            try {
                const response = await fetch('/api/query-claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        originalText: translationData.originalText,
                        highlightedSentence: conversationHistory.selectedContext,
                        userQuestion: question,
                        conversationHistory: conversationHistory.messages.slice(0, -1), // Don't include current message
                        model: translationData.model
                    })
                });

                if (!response.ok) {
                    throw new Error(`Query failed: ${response.statusText}`);
                }

                const result = await response.json();
                conversationHistory.currentResponse = result.response;
                
                // Add assistant response to history
                conversationHistory.messages.push({
                    role: 'assistant',
                    content: result.response,
                    timestamp: new Date()
                });
                
                // Display response
                displayResponse(result.response);
                
                // Update conversation history display
                updateConversationHistory();
                
                // Clear input and show continue button
                document.getElementById('query-input').value = '';
                document.getElementById('continue-btn').style.display = 'inline-block';
                document.getElementById('clear-conversation-btn').style.display = 'inline-block';
                document.getElementById('conversation-history-container').style.display = 'block';
                
                // Show response controls
                document.getElementById('copy-btn').style.display = 'inline-block';
                document.getElementById('markdown-toggle').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Query error:', error);
                responseEl.textContent = `Error: ${error.message}`;
            } finally {
                queryBtn.disabled = false;
                if (continueBtn) continueBtn.disabled = false;
            }
        }

        function displayResponse(response) {
            const responseEl = document.getElementById('query-response');
            
            if (conversationHistory.showRawMarkdown) {
                responseEl.textContent = response;
                responseEl.className = 'p-4 whitespace-pre-wrap font-mono text-sm';
            } else {
                responseEl.innerHTML = marked.parse(response);
                responseEl.className = 'p-4 markdown-body';
            }
        }

        function updateConversationHistory() {
            const historyEl = document.getElementById('conversation-history');
            
            if (conversationHistory.messages.length === 0) {
                historyEl.innerHTML = '<div class="conversation-empty">No conversation history yet</div>';
                return;
            }
            
            historyEl.innerHTML = '';
            
            // Show last few messages (keep it manageable)
            const recentMessages = conversationHistory.messages.slice(-6);
            
            recentMessages.forEach((msg, index) => {
                // Skip the last message if it's the current response
                if (index === recentMessages.length - 1 && msg.role === 'assistant') {
                    return;
                }
                
                const msgDiv = document.createElement('div');
                msgDiv.className = msg.role === 'user' ? 'message-user' : 'message-assistant';
                
                const roleLabel = msg.role === 'user' ? '您 You' : 'AI';
                const preview = msg.content.length > 100 ? 
                    msg.content.substring(0, 100) + '...' : 
                    msg.content;
                
                msgDiv.innerHTML = `<strong>${roleLabel}:</strong> ${preview}`;
                historyEl.appendChild(msgDiv);
            });
            
            // Scroll to bottom
            historyEl.scrollTop = historyEl.scrollHeight;
        }

        function clearConversation() {
            conversationHistory.messages = [];
            conversationHistory.currentResponse = '';
            document.getElementById('conversation-history').innerHTML = 
                '<div class="conversation-empty">No conversation history yet</div>';
            document.getElementById('query-response').innerHTML = '';
            document.getElementById('continue-btn').style.display = 'none';
            document.getElementById('clear-conversation-btn').style.display = 'none';
            document.getElementById('conversation-history-container').style.display = 'none';
            document.getElementById('copy-btn').style.display = 'none';
            document.getElementById('markdown-toggle').style.display = 'none';
        }

        async function copyToClipboard() {
            const text = conversationHistory.showRawMarkdown ? 
                conversationHistory.currentResponse : 
                document.getElementById('query-response').innerText;
            
            try {
                await navigator.clipboard.writeText(text);
                const copyBtn = document.getElementById('copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✓ Copied!';
                copyBtn.classList.add('copy-success');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copy-success');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            }
        }

        function toggleMarkdown() {
            conversationHistory.showRawMarkdown = !conversationHistory.showRawMarkdown;
            const toggleBtn = document.getElementById('markdown-toggle');
            
            if (conversationHistory.showRawMarkdown) {
                toggleBtn.textContent = '渲染 · Rendered';
            } else {
                toggleBtn.textContent = '原始 · Raw';
            }
            
            displayResponse(conversationHistory.currentResponse);
        }

        // Event Listeners for Enhanced Query Interface
        document.getElementById('query-btn').addEventListener('click', () => sendQuery(false));
        document.getElementById('continue-btn').addEventListener('click', () => sendQuery(true));
        document.getElementById('clear-conversation-btn').addEventListener('click', clearConversation);
        document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
        document.getElementById('markdown-toggle').addEventListener('click', toggleMarkdown);

        // Enable Enter key for query
        document.getElementById('query-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('query-btn').disabled) {
                if (conversationHistory.messages.length > 0) {
                    sendQuery(true);
                } else {
                    sendQuery(false);
                }
            }
        });
        
        // Initialize output language options on load
        updateOutputLanguageOptions();
    </script>
</body>
</html>